# Безопасность и управление секретами

Документ описывает политику безопасности в AIChallenge: хранение и использование секретов (API-ключи), сетевые правила, контроль доступа, безопасное логирование и основы безопасной разработки. Согласован с Чистой архитектурой, KMP, Koin, Ktor, Coroutines, а также AIChallenge-StyleGuide.md и .clinerules/Project-rules.md.

Содержание:
- Цели и принципы
- Классификация данных и секретов
- Хранение и доступ к секретам
- Сетевая безопасность и защита трафика
- Безопасное логирование и диагностика
- Контроль доступа и конфигурации
- Практики безопасной разработки (SDLC)
- Инциденты и ротация ключей
- Чек-лист безопасности

## Цели и принципы

- Минимизировать риск утечки секретов и чувствительных данных.
- Соблюдать принцип наименьших привилегий (Least Privilege).
- Избегать хранения секретов в коде/репозитории (включая историю git).
- Разделять конфигурацию по окружениям (dev/stage/prod), не смешивать ключи.

## Классификация данных и секретов

- Публичные данные: можно логировать без ограничений.
- Внутренние данные: логируются агрегированно, без персональных идентификаторов.
- Секреты (API-ключи, токены, пароли): нельзя хранить в коде; маскировать в логах; доступ строго через безопасные провайдеры.
- Персональные данные (PII): не хранить/не логировать; если требуется — анонимизировать/псевдонимизировать.

## Хранение и доступ к секретам

- Провайдер хранилища:
  - Контракт: `shared/src/commonMain/kotlin/ru/izhxx/aichallenge/di/DataStoreProvider.kt`
  - Платформенные реализации:
    - Android: `shared/src/androidMain/.../di/DataStoreProvider.android.kt` (использовать шифрование, если возможно)
    - JVM/desktop: `shared/src/jvmMain/.../di/DataStoreProvider.jvm.kt` (локальные зашифрованные файлы/переменные окружения)
- Доступ к ключам:
  - Только в Data/DI-слое.
  - UI/Presentation не оперирует ключами напрямую.
- Передача секретов в API-клиент:
  - Через DI-конфигурацию, не вшивать в код.
  - Параметры запроса/заголовки формировать на уровне Data-слоя.

## Сетевая безопасность и защита трафика

- Протоколы:
  - Только HTTPS/TLS для удалённых вызовов (Ktor).
- Конфигурация клиента:
  - Включить таймауты, валидацию сертификатов, опционально пиннинг (если применимо).
  - Ограничить редиректы и следовать политике повторов (retry) только для безопасных методов.
- Защита от экспозиции секретов:
  - В заголовках Authorization/API-key — исключить случайный вывод в логи (маскирование обязательно).
- Обработка ошибок:
  - Нормализовать сообщения (без деталей протокола/структуры ответов, см. ErrorHandling.md).

## Безопасное логирование и диагностика

- Маскировка:
  - `Authorization`, `api-key`, токены и конфиденциальные параметры — заменяются на "***".
- Уровни логирования:
  - BODY-тела запросов/ответов логировать только в dev при явном флаге.
  - В prod — HEADERS/INFO с маскированием.
- Корреляционные ID:
  - Присваивать и логировать correlationId для трассировки.
- Исключения:
  - Стэктрейсы логируются на Data/Server-слое (debug/error), в UI — только user-friendly сообщение.

## Контроль доступа и конфигурации

- Конфиги:
  - Конфигурация окружений (URLs, таймауты, флаги логгирования) — через DI и внешние файлы/переменные окружения, не в коде.
- Роли и права:
  - Если появляются роли/учётные записи — централизовать в Domain/Service, UI не должен знать о механике авторизации.
- Разделение окружений:
  - Разные ключи/базы/URLs для dev/stage/prod; раздельные аккаунты у провайдеров.

## Практики безопасной разработки (SDLC)

- Code review:
  - Проверять отсутствие секретов в изменениях, соответствие ErrorHandling и Logging-Metrics.
- Линтеры/сканеры:
  - Использовать git hooks/CI для поиска секретов (secret scanners).
- Зависимости:
  - Регулярно обновлять версии; отслеживать уязвимости (Dependabot/Gradle Versions).
- Тестовые данные:
  - Использовать фиктивные/обезличенные данные; не выгружать реальные в тесты.

## Инциденты и ротация ключей

- Утечка ключа:
  - Немедленная ротация ключей у провайдера, отзыв скомпрометированного ключа.
  - Поиск и удаление ключа из истории репозитория (git filter-repo).
  - Аудит логов/метрик на необычную активность.
- Процедура ротации:
  - Хранить в документации доступ к панели провайдера, порядок генерации нового ключа и обновления конфигов.

## Чек-лист безопасности

- [ ] Секреты не присутствуют в репозитории (включая историю).
- [ ] Доступ к секретам осуществляется только через Data/DI.
- [ ] Маскирование секретов в логах настроено.
- [ ] HTTPS и валидные сертификаты обязательны.
- [ ] Политики таймаутов/ретраев настроены безопасно.
- [ ] Разделены конфиги окружений; ключи различаются.
- [ ] Линтеры/сканеры секретов подключены (в CI или локально).
- [ ] Прописана процедура ротации ключей на случай инцидента.
