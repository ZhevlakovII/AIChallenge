# Логирование и метрики

Документ описывает политику логирования и сбора метрик в AIChallenge. Согласован с Чистой архитектурой, KMP, Koin, MVI и сетевым стеком Ktor. Основан на AIChallenge-StyleGuide.md и .clinerules/Project-rules.md.

Содержание:
- Цели и принципы
- Уровни логирования и формат записей
- Зоны ответственности слоёв (Presentation/Domain/Data/Server)
- Логирование сети (Ktor) и маскирование секретов
- Бизнес-метрики и технические метрики
- Метрики диалогов/LLM (токены, задержки, частота ошибок)
- Практики KMP и платформенные аспекты
- Примеры
- Чек-лист качества

## Цели и принципы

- Диагностируемость: воспроизводимость проблем по логам и метрикам без доступа к чувствительным данным.
- Минимизация шума: полезные, структурированные записи, уместные уровни.
- Безопасность: маскирование секретов/PII, отсутствие утечек DTO/сырых ответов вне Data/Server.
- Переносимость: общий интерфейс логгера и метрик в commonMain, платформенная реализация в androidMain/jvmMain.

## Уровни логирования и формат записей

- Уровни:
  - debug — подробная диагностика (в dev/при отладке).
  - info — бизнес-события, нормальный ход работы.
  - error — ошибки, исключительные ситуации.
- Формат:
  - timestamp, level, tag (класс/фича), message, context (ключевые поля), optional throwable.
- Контекст:
  - Корреляционный ID запроса/диалога, user/session ID (если есть), номера попыток, размеры payload (без содержимого).

## Зоны ответственности слоёв

- Data:
  - Логирование вызовов к внешним системам (Ktor/DB/DataStore) c маскированием.
  - Логирование ошибок маппинга/сериализации, ретраев, таймаутов.
- Domain:
  - Минимум логирования; допускаются ключевые бизнес-решения/ветки (в debug).
- Presentation:
  - Логирование бизнес-событий UI (выбор диалога, отправка сообщения), навигации (в debug).
  - Без логирования секретов или технических деталей API.
- Server:
  - Логи HTTP-запросов/ответов, обработчиков, ошибок.

## Логирование сети (Ktor) и маскирование секретов

- Включать Ktor Logging с кастомным логгером.
- Маскировать:
  - Authorization/api-key/токены.
  - Содержимое тел (BODY) только в dev-режиме и при явном флаге.
- Корреляция:
  - Генерировать корреляционный ID и пробрасывать в headers.
  - Логировать пары (correlationId, route, status, latencyMs).

## Бизнес-метрики и технические метрики

- Бизнес:
  - Кол-во отправленных/полученных сообщений, частота действий пользователя, сценарии успех/отказ.
- Технические:
  - Латентность запросов, коды ответов, кол-во ретраев, таймаутов, ошибки сериализации.
  - Использование памяти/CPU (при необходимости на сервере).
- Хранение/отправка:
  - В общих случаях сбор локально и отображение на экране метрик.
  - При подключении внешней системы — адаптеры в Data/Server.

## Метрики диалогов/LLM

- Токены:
  - Подсчёт входящих/исходящих токенов (при возможности/доступности данных от провайдера).
- Стоимость:
  - Оценка стоимости запроса (если тарифы доступны).
- Качество:
  - Частота ошибок генерации, rate перегенераций/ретраев.
- Экран метрик:
  - composeApp/src/commonMain/kotlin/ru/izhxx/aichallenge/features/metrics/ChatMetricsScreen.kt — точка отображения.

## Практики KMP и платформенные аспекты

- Общий интерфейс `Logger`:
  - shared/src/commonMain/kotlin/ru/izhxx/aichallenge/common/Logger.kt
- Платформенная реализация:
  - Android: shared/src/androidMain/.../common/Logger.kt
  - JVM: shared/src/jvmMain/.../common/Logger.kt
- Метрики:
  - В common — контракты и модели (например, ChatMetrics), в платформах — сбор/репортинг.

## Примеры

Логирование бизнес-события в ViewModel:
```kotlin
class SomeViewModel(
    private val logger: Logger = Logger.forClass(SomeViewModel::class)
) : ViewModel() {
    fun onDialogSelected(id: String) {
        logger.i("Выбран диалог", mapOf("dialogId" to id))
        // ...
    }
}
```

Логирование сети с маскированием:
```kotlin
install(Logging) {
    logger = object : Logger {
        override fun log(message: String) {
            val sanitized = message
                .replace(Regex("(?i)Authorization: .*"), "Authorization: ***")
                .replace(Regex("(?i)api-key=([^&\\s]+)"), "api-key=***")
            platformLogDebug(sanitized)
        }
    }
    level = LogLevel.HEADERS // BODY только в dev
}
```

Счётчик метрик токенов (псевдокод):
```kotlin
data class TokenUsage(val prompt: Int, val completion: Int)
fun recordTokenUsage(usage: TokenUsage) {
    // агрегировать и публиковать на ChatMetricsScreen
}
```

## Чек-лист качества

- [ ] Маскирование секретов в логах включено; BODY логируется только в dev по флагу.
- [ ] Корреляционный ID присутствует в логах сети и бизнес-событий.
- [ ] Бизнес-метрики и технические метрики определены и собираются.
- [ ] Логи информативны: контекст, уровни, без лишнего шума.
- [ ] Logger и метрики реализованы платформенно (androidMain/jvmMain), контракты — в commonMain.
