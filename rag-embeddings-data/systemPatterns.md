# Системные паттерны и конвенции

Статус: Draft
Последнее обновление: 2025-11-21

Кросс-ссылки
- Продуктовый контекст: [productContext.md](./productContext.md)
- Технический контекст: [techContext.md](./techContext.md)
- Архитектурные решения (ADR): [decisions/](./decisions/)
- Заметки сессий: [sessions/](./sessions/)
- Бриф проекта: [projectbrief.md](./projectbrief.md)
- Документация (human): [../docs/human/](../docs/human/)
  - Архитектура: [../docs/human/Architecture.md](../docs/human/Architecture.md)
  - Стандарты кодирования: [../docs/human/CodingStandards.md](../docs/human/CodingStandards.md)
  - API и сеть: [../docs/human/API-Networking.md](../docs/human/API-Networking.md)
  - Обработка ошибок: [../docs/human/ErrorHandling.md](../docs/human/ErrorHandling.md)
  - Логирование/Метрики: [../docs/human/Logging-Metrics.md](../docs/human/Logging-Metrics.md)
  - Тестирование: [../docs/human/TestingStrategy.md](../docs/human/TestingStrategy.md)
  - Безопасность: [../docs/human/Security.md](../docs/human/Security.md)
  - Структура проекта: [../docs/human/ProjectStructure.md](../docs/human/ProjectStructure.md)
- Документация (llm): [../docs/llm/](../docs/llm/)
- Связанный ADR миграции KMP: [decisions/ADR-2025-11-21-multимодульная-миграция-KMP.md](./decisions/ADR-2025-11-21-multимодульная-миграция-KMP.md)

Резюме (TL;DR)
- Этот документ — единый источник истин (SSoT) по системным паттернам и командным конвенциям.
- Любое принятие/изменение паттерна проходит через ADR. После статуса Accepted в ADR — соответствующий паттерн здесь обновляется/добавляется.
- Язык — RU. Формат дат — YYYY-MM-DD. Трассируемость: ADR ↔ systemPatterns ↔ sessions/progress.

Правила оформления и трассируемости
- Обозначение паттернов: SP-XXX (например, SP-001). Идентификатор фиксируется в ADR и в этом каталоге.
- Жизненный цикл: Draft → Proposed (ADR) → Accepted/Rejected → Superseded (c указанием заменяющего SP).
- Для каждого изменения:
  1) Создать/обновить ADR по шаблону: [./_templates/ADR-template.md](./_templates/ADR-template.md)
  2) После принятия — синхронизировать запись ниже (каталог паттернов)
  3) Добавить ссылку на сессию/прогресс, где решение было принято: [sessions/](./sessions/), [progress.md](./progress.md)
- Формат записи паттерна:
  - Идентификатор и название
  - Контекст (когда применять)
  - Решение/Правило
  - Примеры (код/структуры)
  - Последствия (trade-offs)
  - Связанные ADR/документы

Каталог паттернов (инициализация)
A. Архитектурные принципы и модульность
- SP-001: Топология модулей KMP и инварианты зависимостей
  - Контекст: Переход к мультимодульной архитектуре (frontend/backend/shared/instances) с жесткими границами.
  - Решение:
    - Группы модулей:
      - :shared
        - :shared:core:*
        - :shared:contracts:*
      - :frontend
        - :frontend:core:*
        - :frontend:features:<feature>:{api,impl}
      - :backend
        - :backend:core:*
        - :backend:features:<feature>:{api,impl}
      - :instances
        - :instances:frontend:<platform>
        - :instances:servers:<server>
    - Инварианты:
      - Горизонтальные зависимости между фичами запрещены.
      - Сервер не зависит от фронтенда; общие DTO/роуты/ошибки — только в :shared:contracts.
      - DI-границы совпадают с границами Gradle-модулей.
  - Пример: См. [../docs/human/ProjectStructure.md](../docs/human/ProjectStructure.md)
  - Последствия: Упрощение тестирования/релизов, явные границы ответственности, build fail при нарушении инвариантов.
  - Связи: ADR: [decisions/ADR-2025-11-21-multимодульная-миграция-KMP.md](./decisions/ADR-2025-11-21-multимодульная-миграция-KMP.md), Техконтекст: [techContext.md](./techContext.md), Глоссарий: [glossary.md](./glossary.md)

- SP-002: Контракты как интерфейсы в domain (shared)
  - Контекст: Требуется слабая связность и тестируемость.
  - Решение: Доменные интерфейсы в shared/domain, реализации в data/или платформах.
  - Пример: Интерфейс Repository в domain, реализация в data/repository.
  - Последствия: Чище тесты, больше кода-оберток.
  - Связи: ADR: (TBD)

B. DI и зависимости
- SP-010: Koin-модули по слоям
  - Контекст: Единообразное предоставление зависимостей.
  - Решение: Модули DI сгруппированы по областям (data, domain, platform), экспорт минимум необходимых биндингов.
  - Пример: shared/src/commonMain/kotlin/.../di/*
  - Последствия: Прозрачная инициализация, явные границы.

C. API и сеть
- SP-020: Единый клиент Ktor и политики
  - Контекст: Сетевые вызовы в shared.
  - Решение: Общий клиент с перехватчиками логирования, таймаутами, ретраями по ADR.
  - Пример: см. [../docs/human/API-Networking.md](../docs/human/API-Networking.md)
  - Последствия: Централизация, влияние на все запросы.

D. Обработка ошибок
- SP-030: Безопасные вызовы и типизированные ошибки
  - Контекст: Единая стратегия ошибок.
  - Решение: Использовать SafeApiCall/Result типы, маппинг HTTP/IO/бизнес-ошибок. DomainException — в :shared:core:exceptions. SafeApiCall — в :frontend:core:common.
  - Пример: :frontend:core:common/SafeApiCall.*; :shared:core:exceptions/DomainException.*
  - Последствия: Предсказуемость, шаблонный код.
  - Связи: [../docs/human/ErrorHandling.md](../docs/human/ErrorHandling.md), ADR: [decisions/ADR-2025-11-21-multимодульная-миграция-KMP.md](./decisions/ADR-2025-11-21-multимодульная-миграция-KMP.md)

E. Данные, маппинг и парсинг
- SP-040: Mapper-слой между DTO и доменом
  - Контекст: Отделение транспортных моделей.
  - Решение: Явные мапперы, отсутствие DTO в UI/Domain.
  - Последствия: Больше файлов, но устойчивые границы.

F. Логирование и метрики
- SP-050: Категории логов и кореляция
  - Контекст: Трассировка и наблюдаемость.
  - Решение: Общий Logger, уровни по руководству, корелляция запросов где возможно.
  - Связи: [../docs/human/Logging-Metrics.md](../docs/human/Logging-Metrics.md)

G. UI и состояние (Compose)
- SP-060: Однонаправленный поток данных (UDF)
  - Контекст: Управление состоянием экранов.
  - Решение: ViewModel + State/Events, побочные эффекты контролируемы.
  - Последствия: Прозрачность, меньше скрытых состояний.

H. Тестирование и качество
- SP-070: Пирамидa тестов и правила именования
  - Контекст: Баланс unit/integration/e2e.
  - Решение: Обязательные юнит-тесты для мапперов/юзкейсов, именование <Class>Test.
  - Связи: [../docs/human/TestingStrategy.md](../docs/human/TestingStrategy.md)

I. Безопасность и приватность
- SP-080: Никаких секретов в репозитории
  - Контекст: Управление секретами.
  - Решение: Только переменные окружения/CI секреты, локальные файлы исключены .gitignore.
  - Связи: [../docs/human/Security.md](../docs/human/Security.md)

J. Конфигурации и окружения
- SP-090: Конфигурации через Gradle properties/env
  - Контекст: Окружения dev/stage/prod.
  - Решение: Не кодировать значения в исходниках, поставлять через конфигурацию.
  - Последствия: Явная настройка в CI/CD.

K. Версионирование и релизы
- SP-100: Семантические версии и CHANGELOG
  - Контекст: Поставка артефактов.
  - Решение: SemVer, changelog генерируется из PR/commit меток.

L. Производительность и ресурсы
- SP-110: Базовые лимиты и профилирование
  - Контекст: Стабильность под нагрузкой.
  - Решение: Ограничения времени/памяти описаны ADR, профилирование перед релизом.

M. Миграции и эволюция
- SP-120: Deprecation-процесс
  - Контекст: Вывод паттернов/контрактов из употребления.
  - Решение: Теги @Deprecated, предупреждения в релиз-нотах, сроки удаления.

N. DevEx и автоматизация
- SP-130: Шаблоны для повторяемых задач
  - Контекст: Быстрая инициализация фич/документов.
  - Решение: Использовать шаблоны из [../docs/llm/templates/](../docs/llm/templates/) и memory-bank/_templates/*.

Как предлагать новый паттерн
- Создайте ADR (Proposed) с мотивацией, альтернативами и оценкой рисков.
- Внесите предложение паттерна в соответствующий раздел (Draft) с ссылкой на ADR.
- После принятия ADR — обновите статус паттерна (Accepted) и добавьте ссылки на реализации/коммиты.

Синхронизация с кодом и документацией
- Любое изменение паттерна должно ссылаться на:
  - Коммиты/PR, где реализация внедрена
  - Связанные документы в docs/human/* и docs/llm/*
  - Сессию, на которой решение принято (sessions/<date>.md)
  - Запись в [progress.md](./progress.md)

История изменений
- 2025-11-21: Инициализация каталога системных паттернов и базовых конвенций.
