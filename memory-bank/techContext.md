# Технический контекст

Статус: Final  
Последнее обновление: 2025-11-21

Кросс-ссылки
- Продуктовый контекст: [productContext.md](./productContext.md)
- Системные паттерны и конвенции: [systemPatterns.md](./systemPatterns.md)
- Архитектурные решения (ADR): [decisions/](./decisions/)
- Заметки сессий: [sessions/](./sessions/)
- Бриф проекта: [projectbrief.md](./projectbrief.md)
- Документация (human): [../docs/human/](../docs/human/)
- Документация (llm): [../docs/llm/](../docs/llm/)

Резюме (TL;DR)
- Назначение продукта (tagline): Kotlin Multiplatform DevX-песочница для создания LLM-клиента, локальных MCP-инструментов, серверов для общения с MCP/LLM и экспериментов с LLM при строгой архитектуре и воспроизводимости.
- Моно-репозиторий Kotlin Multiplatform: клиент (Compose Multiplatform), разделяемая логика (shared), сервер (Ktor).
- Платформы: Android, iOS, Desktop (Windows/Linux/macOS через JVM).
- Технологии: UI — Compose Multiplatform; DI — Koin; сеть — Ktor (клиент/сервер); сборка — Gradle Kotlin DSL.
- НФТ/SLO (MVP): p95 чат ≤ 2 c (без ожидания LLM), p95 MCP ≤ 1 c; RAM ≤ 200 МБ; целевые устройства — 4 ядра @ 2 ГГц, 4 ГБ ОЗУ; офлайн — доступ к истории/задачам.

1. Архитектура репозитория и модулей
1.1. composeApp
- Назначение: UI-слой на Compose Multiplatform для Android, iOS и Desktop (JVM).
- Точки входа:
  - Android: `composeApp/src/androidMain/kotlin/.../MainActivity.kt`
  - iOS: `composeApp/src/iosMain/kotlin/.../MainViewController.kt` (UIKit bridge для Compose)
  - Desktop/JVM: `composeApp/src/jvmMain/kotlin/.../main.kt`
- Зависимости: `shared` (модели/use-cases/репозитории), Koin для DI.
- Навигация/состояния: унифицированные `ViewModel`/`State` по шаблонам из [../docs/llm/templates/](../docs/llm/templates/).

1.2. shared
- Назначение: общая бизнес-логика, модели, абстракции над данными/сервисами, платформенные границы.
- Подсистемы:
  - `common`: утилиты (логирование, константы, безопасные вызовы).
  - `data`: API-клиенты (Ktor), мапперы, репозитории, парсеры.
  - `domain`: use-cases и интерфейсы сервисов.
- DI: модули в `shared/src/commonMain/kotlin/.../di/`, платформенные провайдеры — в `androidMain`/`iosMain`/`jvmMain`.

1.3. server
- Назначение: Ktor-сервер (эндпоинты, интеграции, вспомогательные сервисы).
- Конфигурация: `server/src/main/kotlin/.../Application.kt`; логирование — `server/src/main/resources/logback.xml`.
- Расширяемость: роуты, плагины, middleware; интеграция с БД (при появлении).

Общие принципы
- Чистая архитектура, слои не нарушают направленности зависимостей.
- Контракты (API/данные/ошибки) и значимые соглашения фиксируются ADR’ами и отражаются в [systemPatterns.md](./systemPatterns.md).

2. Платформы, окружения и версии
- Платформы: Android, iOS, Desktop (JVM).
- Android: minSdk 26; targetSdk 35; compileSdk 35.
- JVM/Desktop: JDK 21.
- Минимальные версии инструментов: Kotlin ≥ 2.2.21; Gradle ≥ 8.14; AGP ≥ 8.13.
- Профили сборки: `debug`, `release`.

3. UI и управление состоянием
- UI: Compose Multiplatform; дизайновая система и темы — модульные.
- Состояния: иммутабельные `State`-объекты, однонаправленный поток данных, side-effects через корутины.
- Навигация: простой стек/плоская навигация по экранам; глубокие переходы — ADR при необходимости.
- Доступность: базовая поддержка; расширение в будущих релизах.

4. DI и конкурентность
- DI: Koin, модули по фичам (chat, settings, mcp, reminder, history, rag).
- Коррутины: `Dispatchers.IO/Default/Main`; structured concurrency; отменяемость и timeouts.
- Параллелизм: стандартный (до 64) без ручной перенастройки на MVP.

5. Данные, хранение, безопасность
- Локальные данные:
  - Room (KMP) для сущностей/кэшей.
  - DataStore-like для конфигураций/настроек.
- Шифрование:
  - Секреты/токены — всегда шифруются.
  - История чатов — хранение по умолчанию не шифруется; опционально может быть включено (фича для пост-MVP).
- Хранение ключей:
  - Android — Android Keystore.
  - iOS — Keychain (с использованием Secure Enclave при наличии).
  - Desktop — зашифрованный файл (AES-256-GCM) на диске; пароль — запрашивается у пользователя и не хранится в явном виде.
- Ретенция:
  - История чатов хранится до явной очистки пользователем.
  - Логи на клиенте в release не сохраняются на диск длительно.
- PII/PD: не обрабатываются.

6. Сетевое взаимодействие и API
- Базовый адрес (локальная разработка): `http://localhost:8080/api`.
- Клиент: Ktor Client с плагинами (timeouts, logging, content negotiation).
- Таймауты: connect — 10s; read — 20s.
- Повторы: до 5 попыток с экспоненциальной задержкой и джиттером.
- Контракты:
  - Формат — JSON; даты — ISO-8601 (UTC, `Z`).
  - Ошибки — `{ code, message, details?, traceId? }`, трассировка — через `traceId`.
- HTTP-логирование:
  - Debug — BODY (маскирование секретов).
  - Release — BASIC или OFF (без секретов).
- Версионирование API: документировать ADR’ами, отражать в [systemPatterns.md](./systemPatterns.md).

7. LLM и MCP
- LLM-провайдер: OpenAI API-like; модель не закреплена жёстко; поддержка streaming-ответов.
- Инференс: токены/ключи — вводит пользователь; конфигурация провайдера хранится локально (шифрованно).
- MCP:
  - Внешние MCP-сервера — разрешены (whitelist по доменам/URL).
  - Встроенные MCP-инструменты: `notes`, `web_fetch`, `calendar` (базовый набор).
  - Производительность: p95 вызова MCP ≤ 1 c; таймаут инструмента 2–3 c.
  - Безопасность: дефолтно минимальные привилегии; явные подтверждения опасных операций.
- Сохранение: список MCP, их конфиги и разрешения — в зашифрованном хранилище.

8. Логирование и метрики
- Клиент:
  - Общий `Logger` в `shared/common`, уровни зависят от профиля.
  - Debug: DEBUG/VERBOSE; Release: минимально необходимый уровень или OFF.
  - PII/секреты — не логировать (в dev — по флагу и с маскированием).
- Сервер:
  - logback с async appenders; формат JSON для агрегации.
  - Корреляция: `traceId`/`requestId` сквозь вызовы.
- Метрики:
  - In-memory сбор на клиенте и сервере, экспорт как JSON по запросу.
  - Ключевые метрики: p95 чат (без ожидания LLM), p95 MCP, ошибки по категориям, ретраи.

9. Тестирование и качество
- Unit: JUnit5, MockK, Turbine (Flow).
- Интеграционные: Ktor `ServerTest`, тестовый `HttpClient`.
- E2E: Kaspresso (Android).
- Покрытие: целевой ориентир 95–99% на критических модулях (не является hard gate на MVP).
- Конвенции: именование/структура — [../docs/human/TestingStrategy.md](../docs/human/TestingStrategy.md).
- Статический анализ: `ktlint` + `detekt`.

10. Профили, секреты и конфигурации
- Профили: `debug`, `release`.
- Секреты: только через переменные окружения и `gradle.properties`; не включать в репозиторий/артефакты.
- Порядок приоритета конфигураций: ENV > gradle.properties > runtime-настройки пользователя.
- Feature flags: в MVP отсутствуют (кроме внутренних переключателей для отладки).

11. Сборка, артефакты и дистрибуция
- Android: APK (debug/release, подпись релиза — локально).
- iOS: IPA/архив Xcode; подпись/профилировка — через Apple Developer Program (детали — отдельным ADR).
- Desktop (JVM):
  - Fat JAR (универсальный).
  - Установщики: exe/dmg/deb/rpm (через Compose/JPackage; параметры — отдельным ADR при вводе).
- CI/CD: пока отсутствует; сборки локально. Добавление — через ADR.
- Репродуцируемость: фиксированные версии зависимостей; deterministic build где возможно.

12. Нефункциональные требования (SLO/SLI)
- Производительность: p95 чат ≤ 2 c (без ожиданий LLM); p95 MCP ≤ 1 c.
- Память: RAM ≤ 200 МБ (клиент).
- Целевые устройства: 4 ядра @ ~2 ГГц, 4 ГБ ОЗУ.
- Офлайн: доступ к истории чатов и списку задач; операции, требующие сети, — деградация с понятными сообщениями.
- Надёжность: ≥ 98% успешных операций; корректная обработка ошибок и возможность повтора.

13. Локализация и доступность
- Локализация: RU (сейчас), EN (позже).
- Доступность (a11y): базовый уровень; расширение по мере развития.

14. Лицензирование и зависимости
- Лицензия проекта: MIT.
- Ограничения сторонних библиотек: отсутствуют (следить за лицензиями зависимостей).

15. Процесс изменений и трассируемость
- Любое значимое изменение — через ADR:
  1) Создать ADR по шаблону [./_templates/ADR-template.md](./_templates/ADR-template.md)
  2) Жизненный цикл: Proposed → Accepted/Rejected → (при необходимости) Superseded
  3) После принятия — обновить соответствующие разделы и [systemPatterns.md](./systemPatterns.md)
- Трассируемость:
  - ADR ↔ коммиты/PR (ссылки обязательны)
  - ADR ↔ `systemPatterns.md` (идентификаторы и ссылки)
  - ADR/паттерны ↔ сессии ([sessions/](./sessions/)) и журнал прогресса ([progress.md](./progress.md))

16. Известные ограничения и риски
- Неопределённости API/метрик — уточнять итеративно, фиксировать ADR.
- Платформенные различия между Android/iOS/Desktop (JVM) — выравнивать через платформенные провайдеры.
- Нагрузочные и безопасностные аспекты сервера — требуют отдельных измерений и ADR.

История изменений
- 2025-11-21: Обновление на JVM-only: исключены iOS/Native и связанные артефакты/механизмы хранения.
- 2025-11-21: Финализация techContext.md на основе интервью; зафиксированы архитектура, процессы, НФТ, тестирование, безопасность, сборка.
- 2025-11-21: Возврат iOS в охват: добавлены iOS в платформы, Keychain в безопасность, артефакт IPA в сборку.
